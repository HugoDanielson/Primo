<script>
  import { onMount, onDestroy } from 'svelte';
  import { slide } from 'svelte/transition';
  import { iframePreview } from './misc';
  import {locale, highlightedElement } from '../../stores/app/misc'
  import JSONTree from 'svelte-json-tree';
  import Icon from '@iconify/svelte'

  export let view = 'small';
  export let loading = false;
  export let hideControls = false;
  export let componentApp;
  export let error = null;
  export let data = {}

  let consoleLog

  let iframe;
  let previewLoaded = false;
  $: if (iframe) {
    iframe.contentWindow.addEventListener('message', ({data}) => {
      if (data === 'done') {
        previewLoaded = true;
      } else if (data.event === 'logs') {
        // consoleLog = data.payload
      } else if (data.event === 'path') {
        $highlightedElement = data.payload
      }
    });
  }

  let container;
  let iframeLoaded = false;

  function resizePreview() {
    if (view) {
      const { clientWidth: parentWidth } = container;
      const { clientWidth: childWidth } = iframe;
      const scaleRatio = parentWidth / childWidth;
      iframe.style.transform = `scale(${scaleRatio})`;
      iframe.style.height = 100 / scaleRatio + '%';
    }
  }

  function changeView() {
    iframe.classList.remove('fadein');
    setTimeout(() => {
      if (view === 'small') {
        view = 'large';
        // clientWidth doesn't compute right without this
        setTimeout(resizePreview, 100);
      } else {
        iframe.classList.remove('fadein');
        iframe.style.transform = 'scale(1)';
        iframe.style.height = '100%';
        view = 'small';
      }
      setTimeout(() => {
        iframe.classList.add('fadein');
      }, 100);
    }, 100);
  }

  let interval;
  onMount(() => {
    interval = setInterval(resizePreview, 500);
  });
  onDestroy(() => {
    clearInterval(interval);
  });

  $: componentData = data

  $: setIframeApp({
    iframeLoaded,
    componentApp
  });
  function setIframeApp({ iframeLoaded, componentApp }) {
    if (iframeLoaded) {
      iframe.contentWindow.postMessage({ componentApp, componentData });
      if (componentApp && !componentApp.includes('console.log')) {
        consoleLog = null
      }
    }
  }

  $: iframe && highlightTag($highlightedElement)
  function highlightTag(tag) {
    if (tag) {
      iframe.contentWindow.postMessage({ event: 'highlight', payload: tag });
    }
  }

  $: setIframeData(componentData);
  function setIframeData(componentData) {
    if (iframeLoaded) {
      iframe.contentWindow.postMessage({ componentData });
    }
  }

  function setLoading(e) {
    if (!iframeLoaded) {
      iframeLoaded = true;
      return;
    }
    iframeLoaded = false;
    iframe.srcdoc = iframePreview($locale);
  }

  let previewWidth;
  // $: if (previewWidth < 300) previewWidth = 300


  $: activeIcon = getIcon(previewWidth)
  function getIcon(width) {
    if (width < 500) {
      return "bi:phone"
    } else if (width < 1200) {
      return 'ant-design:tablet-outlined'
    } else if (width < 1800) {
      return "bi:laptop"
    } else {
      return 'akar-icons:desktop-device'
    }
  }

</script>

<div class="code-preview">
  {#if error}
    <pre
      transition:slide={{ duration: 100 }}
      class="error-container">
      {@html error}
    </pre>
  {/if}

  {#if consoleLog}
    <div class="logs" transition:slide>
      <div class="log">
        {#if typeof consoleLog === 'object'}
          <JSONTree value={consoleLog} />
        {:else}
          <pre>{@html consoleLog}</pre> 
        {/if}
      </div>
    </div>
  {/if}
  <div
    class="preview-container"
    class:loading
    bind:this={container}
    bind:clientWidth={previewWidth}>
    <iframe
      class:scaled={view === 'large'}
      on:load={setLoading}
      class:fadein={previewLoaded}
      title="Preview HTML"
      srcdoc={iframePreview($locale)}
      bind:this={iframe} />
  </div>
  {#if !hideControls}
    <div class="footer-buttons">
      {#if view === 'small'}
        <div class="preview-width">
          <Icon icon={activeIcon} height="1rem" />
          <span>{previewWidth}</span>
        </div>
        <button class="switch-view" on:click={changeView}>
          <i class="fas fa-expand-arrows-alt" />
          <span>window view</span>
        </button>
      {:else if view === 'large'}
        <div class="preview-width">
          <Icon icon={getIcon(window.innerWidth)} height="1rem" />
          <span>{window.innerWidth}</span>
        </div>
        <button class="switch-view" on:click={changeView}>
          <i class="fas fa-compress-arrows-alt" />
          <span>contained view</span>
        </button>
      {/if}
    </div>
  {/if}
</div>

<svelte:window on:resize={resizePreview} />

<style lang="postcss">
  .code-preview {
    height: 100%;
    display: flex;
    flex-direction: column;

    .error-container {
      color: var(--primo-color-white);
      background: var(--primo-color-primored);
      padding: 5px;
    }

    .logs {
      --json-tree-font-family: 'Fira Code', serif, monospace;
      --json-tree-label-color: #569cd6;

      display: grid;
      gap: 0.5rem;
      background: var(--color-gray-9);
      border: 2px solid var(--color-gray-8);
      padding: 0.75rem 1rem;

      pre {
        display: block;
      }

      .log:not(:only-child):not(:last-child) {
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(250, 250, 250, 0.2);
      }
    }
  }
  iframe {
    width: 100%;
    border: 0;
    transition: opacity 0.2s;
    background: var(--primo-color-white);
    height: 100%;
    width: 100%;
  }
  .fadein {
    opacity: 1;
  }
  iframe.scaled {
    width: 100vw;
    transform-origin: top left;
  }
  .preview-container {
    background: var(--primo-color-white);
    border: 2px solid var(--color-gray-8);
    overflow: hidden;
    transition: border-color 0.2s;
    will-change: border-color;
    border-bottom: 0;
    flex: 1;
  }
  .preview-container.loading {
    border-color: var(--primo-color-primored);
  }
  .footer-buttons {
    display: flex;
    flex-wrap: wrap;

    .preview-width {
      background: var(--primo-color-black);
      color: var(--primo-color-white);
      font-weight: 500;
      z-index: 10;
      display: flex;
      align-items: center;
      padding: 0 1rem;

      span {
        padding-left: 0.5rem;
        font-size: 0.75rem;
      }
    }
  }

  .footer-buttons button {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    flex: 1;
    outline: 0;
    background: var(--color-gray-9);
    border: 1px solid var(--color-gray-8);
    color: var(--color-gray-2);
    font-size: var(--font-size-1);
    padding: 0.5rem 0;
    display: block;
    text-align: center;
    transition: var(--transition-colors);
  }
  .footer-buttons button:hover {
    background: var(--color-gray-8);
  }

</style>
